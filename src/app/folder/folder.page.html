<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title>Camera Demo</ion-title>
    <ion-buttons slot="end">
      <!-- Connection status -->
      <ion-chip [color]="isOnline() ? 'success' : 'danger'">
        <ion-icon [name]="isOnline() ? 'wifi' : 'wifi-outline'"></ion-icon>
        <ion-label>{{ connectionStatus() }}</ion-label>
      </ion-chip>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <!-- Error message -->
  <ion-card *ngIf="errorMessage" color="danger">
    <ion-card-content>
      <ion-icon name="alert-circle" slot="start"></ion-icon>
      {{ errorMessage }}
    </ion-card-content>
  </ion-card>

  <!-- Camera view -->
  <div class="camera-container">
    <div class="video-wrapper">
      <!-- Video element -->
      <video
        #videoElement
        autoplay
        playsinline
        [class.hidden]="!isCameraActive()"
        [class.mirrored]="isMirrored"
      ></video>

      <!-- Overlay canvas for ID card guide -->
      <canvas
        #overlayCanvas
        class="overlay-canvas"
        [class.hidden]="!showOverlay || !isCameraActive()"
        [class.mirrored]="isMirrored"
      ></canvas>

      <!-- Camera placeholder when not active -->
      <div *ngIf="!isCameraActive()" class="camera-placeholder">
        <ion-icon name="camera-outline" size="large"></ion-icon>
        <p>กดปุ่มเพื่อเปิดกล้อง</p>
      </div>
    </div>

    <!-- Camera controls -->
    <div class="controls">
      <ion-button
        *ngIf="!isCameraActive()"
        expand="block"
        color="primary"
        (click)="startCamera()"
      >
        <ion-icon slot="start" name="camera"></ion-icon>
        เปิดกล้อง
      </ion-button>

      <ion-button
        *ngIf="isCameraActive()"
        expand="block"
        color="danger"
        (click)="stopCamera()"
      >
        <ion-icon slot="start" name="stop-circle"></ion-icon>
        ปิดกล้อง
      </ion-button>

      <div class="button-group" *ngIf="isCameraActive()">
        <ion-button expand="block" color="success" (click)="capturePhoto()">
          <ion-icon slot="start" name="camera-outline"></ion-icon>
          ถ่ายรูป
        </ion-button>

        <ion-button
          *ngIf="hasMultipleCameras"
          expand="block"
          color="secondary"
          (click)="switchCamera()"
        >
          <ion-icon slot="start" name="camera-reverse"></ion-icon>
          สลับกล้อง
          <ion-note slot="end"
            >{{ isFrontCamera() ? 'หน้า' : 'หลัง' }}</ion-note
          >
        </ion-button>

        <ion-button expand="block" color="medium" (click)="toggleOverlay()">
          <ion-icon
            slot="start"
            [name]="showOverlay ? 'eye' : 'eye-off'"
          ></ion-icon>
          {{ showOverlay ? 'ซ่อน' : 'แสดง' }} Overlay
        </ion-button>

        <ion-button expand="block" color="tertiary" (click)="toggleMirror()">
          <ion-icon slot="start" name="swap-horizontal"></ion-icon>
          {{ isMirrored ? 'ปกติ' : 'Mirror' }}
          <ion-note slot="end">{{ isMirrored ? 'ON' : 'OFF' }}</ion-note>
        </ion-button>
      </div>
    </div>
  </div>

  <!-- Preview section -->
  <div class="preview-section" *ngIf="capturedImage">
    <ion-card>
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="images"></ion-icon>
          รูปที่ถ่าย
        </ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <div class="preview-wrapper">
          <canvas #previewCanvas class="preview-canvas"></canvas>
        </div>

        <div class="preview-actions">
          <ion-button expand="block" color="primary" (click)="downloadImage()">
            <ion-icon slot="start" name="download"></ion-icon>
            ดาวน์โหลด
          </ion-button>
          <ion-button expand="block" color="light" (click)="clearImage()">
            <ion-icon slot="start" name="trash"></ion-icon>
            ลบ
          </ion-button>
        </div>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Info section -->
  <ion-card>
    <ion-card-header>
      <ion-card-subtitle>Camera Info</ion-card-subtitle>
    </ion-card-header>
    <ion-card-content>
      <ion-list>
        <ion-item>
          <ion-icon name="videocam" slot="start"></ion-icon>
          <ion-label>
            <h3>สถานะกล้อง</h3>
            <p>{{ isCameraActive() ? 'เปิดอยู่' : 'ปิดอยู่' }}</p>
          </ion-label>
        </ion-item>
        <ion-item>
          <ion-icon name="camera-reverse" slot="start"></ion-icon>
          <ion-label>
            <h3>กล้องที่ใช้</h3>
            <p>
              {{ currentFacingMode() === 'user' ? 'กล้องหน้า' : 'กล้องหลัง' }}
            </p>
          </ion-label>
        </ion-item>
        <ion-item>
          <ion-icon name="apps" slot="start"></ion-icon>
          <ion-label>
            <h3>จำนวนกล้อง</h3>
            <p>{{ hasMultipleCameras ? 'มีหลายตัว' : 'มี 1 ตัว' }}</p>
          </ion-label>
        </ion-item>
        <ion-item>
          <ion-icon name="wifi" slot="start"></ion-icon>
          <ion-label>
            <h3>สถานะอินเทอร์เน็ต</h3>
            <p>{{ isOnline() ? 'เชื่อมต่อแล้ว' : 'ไม่ได้เชื่อมต่อ' }}</p>
          </ion-label>
        </ion-item>
        <ion-item>
          <ion-icon name="swap-horizontal" slot="start"></ion-icon>
          <ion-label>
            <h3>Mirror Mode</h3>
            <p>{{ isMirrored ? 'เปิดอยู่ (พลิกภาพ)' : 'ปิดอยู่' }}</p>
          </ion-label>
        </ion-item>
      </ion-list>

      <ion-button expand="block" fill="outline" (click)="getAvailableCameras()">
        <ion-icon slot="start" name="list"></ion-icon>
        ดูรายการกล้องที่มี (Console)
      </ion-button>
    </ion-card-content>
  </ion-card>
</ion-content>
